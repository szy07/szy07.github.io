<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>武汉大学 - 信息门户</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --whu-blue: #1e3a8a;
            --whu-light-blue: #3b82f6;
            --whu-gold: #d4af37;
        }
        
        .whu-blue { background-color: var(--whu-blue); }
        .whu-light-blue { background-color: var(--whu-light-blue); }
        .text-whu-gold { color: var(--whu-gold); }
        
        .hero-section {
            background: linear-gradient(rgba(30, 58, 138, 0.85), rgba(30, 58, 138, 0.9)), 
                        url('https://images.unsplash.com/photo-1541336032412-2048a678540d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center;
            background-size: cover;
            height: 70vh;
        }
        
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .admin-panel, .user-dashboard {
            display: none;
        }
        
        .server-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .status-connected {
            background-color: #10b981;
            color: white;
        }
        
        .status-disconnected {
            background-color: #ef4444;
            color: white;
        }
        
        .status-checking {
            background-color: #f59e0b;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 服务器状态指示器 -->
    <div id="server-status" class="server-status status-checking">
        <i class="fas fa-circle-notch fa-spin mr-1"></i> 检查服务器连接...
    </div>

    <!-- 导航栏 -->
    <nav class="whu-blue text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="h-10 w-10 rounded-full bg-white flex items-center justify-center">
                    <span class="text-blue-800 font-bold">武</span>
                </div>
                <span class="text-xl font-bold">武汉大学</span>
            </div>
            <div class="space-x-4">
                <a href="#" class="hover:text-whu-gold transition duration-300">首页</a>
                <a href="#about" class="hover:text-whu-gold transition duration-300">学校概况</a>
                <a href="#news" class="hover:text-whu-gold transition duration-300">新闻动态</a>
                <a href="#services" class="hover:text-whu-gold transition duration-300">校园服务</a>
                <button id="auth-btn" class="bg-white text-blue-800 px-4 py-1 rounded-lg hover:bg-gray-100 transition duration-300">
                    <i class="fas fa-user mr-1"></i>登录/注册
                </button>
            </div>
        </div>
    </nav>

    <!-- 英雄区域 -->
    <section class="hero-section text-white flex items-center">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">欢迎来到武汉大学</h1>
            <p class="text-xl mb-8 max-w-2xl mx-auto">自强 弘毅 求是 拓新</p>
            <a href="#about" class="bg-white text-blue-800 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-300">
                了解更多
            </a>
        </div>
    </section>

    <!-- 学校概况 -->
    <section id="about" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">学校概况</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-2xl font-semibold mb-4 text-whu-gold">百年学府，底蕴深厚</h3>
                    <p class="text-gray-700 mb-4">
                        武汉大学是国家教育部直属重点综合性大学，是国家"985工程"和"211工程"重点建设高校，是首批"双一流"建设高校。
                    </p>
                    <p class="text-gray-700 mb-4">
                        学校溯源于1893年清末湖广总督张之洞奏请清政府创办的自强学堂，历经传承演变，1928年定名为国立武汉大学，是近代中国第一批国立大学。
                    </p>
                    <p class="text-gray-700">
                        武汉大学环绕东湖水，坐拥珞珈山，校园环境优美，风景如画，被誉为"中国最美丽的大学"。
                    </p>
                </div>
                <div class="flex justify-center">
                    <div class="bg-gray-200 h-80 w-full rounded-lg flex items-center justify-center">
                        <span class="text-gray-500">武汉大学校园风景图</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 新闻动态 -->
    <section id="news" class="py-16 bg-gray-100">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">新闻动态</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <div class="h-48 bg-blue-200 flex items-center justify-center">
                        <span class="text-gray-600">新闻图片</span>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">武汉大学召开2023年本科教育工作会</h3>
                        <p class="text-gray-600 mb-4">10月15日，武汉大学2023年本科教育工作会在人文馆主厅召开...</p>
                        <a href="#" class="text-blue-600 hover:underline">阅读更多</a>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <div class="h-48 bg-green-200 flex items-center justify-center">
                        <span class="text-gray-600">新闻图片</span>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">武大学子在第八届中国国际"互联网+"大赛中获佳绩</h3>
                        <p class="text-gray-600 mb-4">在刚刚结束的第八届中国国际"互联网+"大学生创新创业大赛全国总决赛中...</p>
                        <a href="#" class="text-blue-600 hover:underline">阅读更多</a>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <div class="h-48 bg-yellow-200 flex items-center justify-center">
                        <span class="text-gray-600">新闻图片</span>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">武汉大学新增两个ESI前1%学科</h3>
                        <p class="text-gray-600 mb-4">根据科睿唯安最新公布的ESI数据显示，武汉大学新增两个进入ESI全球排名前1%的学科...</p>
                        <a href="#" class="text-blue-600 hover:underline">阅读更多</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 校园服务 -->
    <section id="services" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">校园服务</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-lg shadow-md p-6 text-center card-hover">
                    <div class="whu-blue w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-book text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">图书馆</h3>
                    <p class="text-gray-600">丰富的图书资源和电子文献</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 text-center card-hover">
                    <div class="whu-blue w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-graduation-cap text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">教务系统</h3>
                    <p class="text-gray-600">选课、成绩查询、课表查看</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 text-center card-hover">
                    <div class="whu-blue w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-id-card text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">校园卡</h3>
                    <p class="text-gray-600">消费、门禁、图书借阅一体化</p>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6 text-center card-hover">
                    <div class="whu-blue w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-laptop text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">网络服务</h3>
                    <p class="text-gray-600">校园网、VPN、邮箱服务</p>
                </div>
            </div>
        </div>
    </section>

    <!-- 页脚 -->
    <footer class="whu-blue text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="h-10 w-10 rounded-full bg-white flex items-center justify-center">
                            <span class="text-blue-800 font-bold">武</span>
                        </div>
                        <span class="text-xl font-bold">武汉大学</span>
                    </div>
                    <p class="text-sm">自强 弘毅 求是 拓新</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">快速链接</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="hover:text-whu-gold transition duration-300">学校首页</a></li>
                        <li><a href="#" class="hover:text-whu-gold transition duration-300">招生信息</a></li>
                        <li><a href="#" class="hover:text-whu-gold transition duration-300">人才招聘</a></li>
                        <li><a href="#" class="hover:text-whu-gold transition duration-300">联系我们</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">联系我们</h3>
                    <ul class="space-y-2">
                        <li><i class="fas fa-map-marker-alt mr-2"></i>湖北省武汉市珞珈山16号</li>
                        <li><i class="fas fa-phone mr-2"></i>(+86) 027-6875XXXX</li>
                        <li><i class="fas fa-envelope mr-2"></i>info@whu.edu.cn</li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">关注我们</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="h-10 w-10 rounded-full bg-white flex items-center justify-center text-blue-800 hover:bg-gray-200 transition duration-300">
                            <i class="fab fa-weixin"></i>
                        </a>
                        <a href="#" class="h-10 w-10 rounded-full bg-white flex items-center justify-center text-blue-800 hover:bg-gray-200 transition duration-300">
                            <i class="fab fa-weibo"></i>
                        </a>
                        <a href="#" class="h-10 w-10 rounded-full bg-white flex items-center justify-center text-blue-800 hover:bg-gray-200 transition duration-300">
                            <i class="fab fa-qq"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-blue-700 mt-8 pt-8 text-center text-sm">
                <p>© 2023 武汉大学 版权所有 | 鄂ICP备XXXXXXXX号</p>
            </div>
        </div>
    </footer>

    <!-- 登录模态框 -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">用户登录</h2>
                    <button id="close-login" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">邮箱地址</label>
                        <input type="email" id="login-email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入邮箱">
                    </div>
                    
                    <div class="mb-6">
                        <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                        <input type="password" id="login-password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入密码">
                    </div>
                    
                    <button type="submit" 
                            class="w-full whu-blue text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                        登录
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">没有账号？<a href="#" id="show-register" class="text-blue-600 hover:underline">立即注册</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">用户注册</h2>
                    <button id="close-register" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-email" class="block text-gray-700 text-sm font-bold mb-2">邮箱地址</label>
                        <input type="email" id="register-email" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入邮箱">
                    </div>
                    
                    <div class="mb-4">
                        <label for="register-password" class="block text-gray-700 text-sm font-bold mb-2">密码</label>
                        <input type="password" id="register-password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入密码（至少6位）">
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirm-password" class="block text-gray-700 text-sm font-bold mb-2">确认密码</label>
                        <input type="password" id="confirm-password" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请再次输入密码">
                    </div>
                    
                    <div class="mb-4">
                        <label for="full-name" class="block text-gray-700 text-sm font-bold mb-2">姓名</label>
                        <input type="text" id="full-name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入真实姓名">
                    </div>
                    
                    <div class="mb-6">
                        <label for="student-id" class="block text-gray-700 text-sm font-bold mb-2">学号/工号</label>
                        <input type="text" id="student-id" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="请输入学号或工号">
                    </div>
                    
                    <button type="submit" 
                            class="w-full whu-blue text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                        注册
                    </button>
                </form>
                
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-600">已有账号？<a href="#" id="show-login" class="text-blue-600 hover:underline">立即登录</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 管理员后台 -->
    <div id="admin-panel" class="admin-panel fixed inset-0 bg-gray-50 z-40 overflow-y-auto">
        <div class="container mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">管理员后台</h2>
                    <div class="flex space-x-2">
                        <button id="refresh-users" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-300">
                            <i class="fas fa-sync-alt mr-1"></i>刷新数据
                        </button>
                        <button id="close-admin" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition duration-300">
                            <i class="fas fa-times mr-1"></i>返回首页
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-4">用户管理</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr class="whu-blue text-white">
                                    <th class="py-2 px-4">ID</th>
                                    <th class="py-2 px-4">邮箱</th>
                                    <th class="py-2 px-4">姓名</th>
                                    <th class="py-2 px-4">学号/工号</th>
                                    <th class="py-2 px-4">角色</th>
                                    <th class="py-2 px-4">注册时间</th>
                                    <th class="py-2 px-4">操作</th>
                                </tr>
                            </thead>
                            <tbody id="users-table">
                                <tr>
                                    <td colspan="7" class="text-center py-4">加载用户数据中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-2">系统统计</h3>
                        <ul class="text-gray-700">
                            <li class="mb-1">• 注册用户: <span id="user-count">0</span></li>
                            <li class="mb-1">• 管理员: <span id="admin-count">0</span></li>
                            <li>• 今日登录: <span id="login-today">0</span></li>
                        </ul>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold mb-2">系统管理</h3>
                        <div class="space-y-2">
                            <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition duration-300">备份数据库</button>
                            <button class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition duration-300">发送系统通知</button>
                            <button class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700 transition duration-300">清除缓存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示 -->
    <div id="message" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden max-w-sm z-50">
        <div class="flex items-center">
            <span id="message-icon" class="mr-2"></span>
            <span id="message-text"></span>
        </div>
    </div>

    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://vkethnxciczquacvhisi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrZXRobnhjaWN6cXVhY3ZoaXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMzA3MTEsImV4cCI6MjA3ODcwNjcxMX0.n8gXVzcrypHjrBi6Q_fd99jv5YkLtF_PIKXO8elA__k';

        // 初始化Supabase客户端
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 当前用户状态
        let currentUser = null;
        let currentUserRole = 'guest';

        // 显示消息提示
        function showMessage(message, type = 'info') {
            const messageEl = document.getElementById('message');
            const messageText = document.getElementById('message-text');
            const messageIcon = document.getElementById('message-icon');
            
            messageText.textContent = message;
            
            // 根据类型设置颜色和图标
            if (type === 'success') {
                messageEl.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg max-w-sm bg-green-100 text-green-800 border border-green-300 z-50';
                messageIcon.innerHTML = '✅';
            } else if (type === 'error') {
                messageEl.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg max-w-sm bg-red-100 text-red-800 border border-red-300 z-50';
                messageIcon.innerHTML = '❌';
            } else {
                messageEl.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg max-w-sm bg-blue-100 text-blue-800 border border-blue-300 z-50';
                messageIcon.innerHTML = 'ℹ️';
            }
            
            messageEl.classList.remove('hidden');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }

        // 检查Supabase连接状态
        async function checkSupabaseConnection() {
            try {
                // 使用简单的认证检查
                const { data, error } = await supabase.auth.getSession();
                
                if (error && error.message.includes('Failed to fetch')) {
                    throw new Error('网络连接失败，请检查网络设置');
                }
                
                // 如果认证检查通过，尝试一个简单的表查询
                const { error: tableError } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                // 即使表查询出错，只要不是网络错误，就认为连接成功
                document.getElementById('server-status').className = 'server-status status-connected';
                document.getElementById('server-status').innerHTML = '<i class="fas fa-check mr-1"></i> 服务器已连接';
                return true;
            } catch (error) {
                console.error('Supabase连接失败:', error);
                document.getElementById('server-status').className = 'server-status status-disconnected';
                document.getElementById('server-status').innerHTML = '<i class="fas fa-times mr-1"></i> 服务器连接失败';
                showMessage('服务器连接失败: ' + error.message, 'error');
                return false;
            }
        }

        // 检查用户认证状态
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error) throw error;
                
                if (user) {
                    currentUser = user;
                    // 获取用户角色
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('role, full_name, student_id')
                        .eq('id', user.id)
                        .single();
                        
                    if (!userError && userData) {
                        currentUserRole = userData.role || 'student';
                        updateAuthButton(user.email, currentUserRole, userData.full_name);
                        
                        // 如果是管理员，自动显示后台管理页面
                        if (currentUserRole === 'admin') {
                            document.getElementById('admin-panel').style.display = 'block';
                            loadAdminData();
                        }
                    } else {
                        // 如果没有在users表中找到记录，默认为学生
                        currentUserRole = 'student';
                        updateAuthButton(user.email, 'student', '用户');
                    }
                }
                
                return user;
            } catch (error) {
                console.error('检查认证状态出错:', error);
                return null;
            }
        }

        // 更新认证按钮状态
        function updateAuthButton(email, role, name) {
            const authBtn = document.getElementById('auth-btn');
            if (role === 'admin') {
                authBtn.innerHTML = `<i class="fas fa-user-shield mr-1"></i>${name || '管理员'}`;
            } else {
                authBtn.innerHTML = `<i class="fas fa-user mr-1"></i>${name || '用户'}`;
            }
        }

        // 邮箱密码注册
        async function signUp(email, password, userData) {
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: userData
                    }
                });

                if (error) throw error;
                
                if (data.user) {
                    // 将用户信息保存到数据库
                    const { error: dbError } = await supabase
                        .from('users')
                        .insert([
                            { 
                                id: data.user.id, 
                                email: data.user.email,
                                full_name: userData.full_name,
                                student_id: userData.student_id,
                                role: email === 'admin@whu.edu.cn' ? 'admin' : 'student',
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (dbError) {
                        console.error('保存用户信息出错:', dbError);
                        showMessage('注册成功，但保存用户信息时出错', 'error');
                    } else {
                        showMessage('注册成功！请检查邮箱验证邮件。', 'success');
                    }
                }
                
                return { data, error: null };
            } catch (error) {
                console.error('注册出错:', error);
                return { data: null, error };
            }
        }

        // 邮箱密码登录
        async function signIn(email, password) {
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;
                return { data, error: null };
            } catch (error) {
                console.error('登录出错:', error);
                return { data: null, error };
            }
        }

        // 退出登录
        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('退出登录出错:', error);
                showMessage('退出登录失败: ' + error.message, 'error');
            } else {
                currentUser = null;
                currentUserRole = 'guest';
                document.getElementById('auth-btn').innerHTML = '<i class="fas fa-user mr-1"></i>登录/注册';
                showMessage('已成功退出登录', 'success');
            }
        }

        // 加载管理员数据
        async function loadAdminData() {
            try {
                // 从数据库获取用户数据
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    // 如果是策略错误，提供更友好的提示
                    if (error.message.includes('infinite recursion') || error.message.includes('policy')) {
                        throw new Error('数据库策略配置错误，请执行提供的SQL语句修复RLS策略');
                    }
                    throw error;
                }

                let userCount = 0;
                let adminCount = 0;
                
                if (users && users.length > 0) {
                    let tableHTML = '';
                    
                    users.forEach(user => {
                        userCount++;
                        if (user.role === 'admin') adminCount++;
                        
                        const regDate = new Date(user.created_at).toLocaleDateString('zh-CN');
                        
                        tableHTML += `
                            <tr>
                                <td class="py-2 px-4 border-b">${user.id.substring(0, 8)}...</td>
                                <td class="py-2 px-4 border-b">${user.email}</td>
                                <td class="py-2 px-4 border-b">${user.full_name || '未设置'}</td>
                                <td class="py-2 px-4 border-b">${user.student_id || '未设置'}</td>
                                <td class="py-2 px-4 border-b">
                                    <span class="${user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'} px-2 py-1 rounded text-sm">
                                        ${user.role === 'admin' ? '管理员' : '学生'}
                                    </span>
                                </td>
                                <td class="py-2 px-4 border-b">${regDate}</td>
                                <td class="py-2 px-4 border-b">
                                    <button class="edit-user bg-blue-500 text-white px-2 py-1 rounded text-sm hover:bg-blue-600 transition duration-300" data-id="${user.id}">编辑</button>
                                    <button class="delete-user bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600 transition duration-300 ml-1" data-id="${user.id}">删除</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    document.getElementById('users-table').innerHTML = tableHTML;
                    
                    // 添加编辑和删除按钮的事件监听
                    document.querySelectorAll('.edit-user').forEach(button => {
                        button.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            editUser(userId);
                        });
                    });
                    
                    document.querySelectorAll('.delete-user').forEach(button => {
                        button.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            deleteUser(userId);
                        });
                    });
                } else {
                    document.getElementById('users-table').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">暂无用户数据</td>
                        </tr>
                    `;
                }
                
                document.getElementById('user-count').textContent = userCount;
                document.getElementById('admin-count').textContent = adminCount;
                document.getElementById('login-today').textContent = Math.floor(Math.random() * 10) + 1; // 模拟今日登录数
                
            } catch (error) {
                console.error('加载用户数据失败:', error);
                document.getElementById('users-table').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-red-500">加载用户数据失败: ${error.message}</td>
                    </tr>
                `;
                showMessage('加载用户数据失败: ' + error.message, 'error');
            }
        }

        // 编辑用户
        async function editUser(userId) {
            showMessage('编辑用户功能正在开发中...', 'info');
        }

        // 删除用户
        async function deleteUser(userId) {
            if (confirm('确定要删除此用户吗？此操作不可恢复。')) {
                try {
                    const { error } = await supabase
                        .from('users')
                        .delete()
                        .eq('id', userId);
                    
                    if (error) throw error;
                    
                    showMessage('用户删除成功', 'success');
                    loadAdminData(); // 重新加载数据
                } catch (error) {
                    console.error('删除用户失败:', error);
                    showMessage('删除用户失败: ' + error.message, 'error');
                }
            }
        }

        // 页面加载时检查认证状态
        document.addEventListener('DOMContentLoaded', () => {
            // 检查Supabase连接状态
            checkSupabaseConnection();
            
            // 检查用户认证状态
            checkAuth().then(user => {
                if (user) {
                    console.log('用户已登录:', user.email);
                }
            });
            
            // 平滑滚动到锚点
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    if (this.getAttribute('href') === '#') return;
                    
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // 登录/注册按钮点击事件
            document.getElementById('auth-btn').addEventListener('click', function() {
                if (currentUser) {
                    // 如果已登录，显示用户菜单
                    if (currentUserRole === 'admin') {
                        document.getElementById('admin-panel').style.display = 'block';
                        loadAdminData();
                    } else {
                        showMessage('您已登录，但没有管理员权限', 'info');
                    }
                } else {
                    // 如果未登录，显示登录模态框
                    document.getElementById('login-modal').style.display = 'flex';
                }
            });
            
            // 关闭模态框事件
            document.getElementById('close-login').addEventListener('click', function() {
                document.getElementById('login-modal').style.display = 'none';
            });
            
            document.getElementById('close-register').addEventListener('click', function() {
                document.getElementById('register-modal').style.display = 'none';
            });
            
            document.getElementById('close-admin').addEventListener('click', function() {
                document.getElementById('admin-panel').style.display = 'none';
            });
            
            // 刷新用户数据按钮
            document.getElementById('refresh-users').addEventListener('click', function() {
                loadAdminData();
                showMessage('用户数据已刷新', 'success');
            });
            
            // 切换登录/注册模态框
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('register-modal').style.display = 'flex';
            });
            
            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('register-modal').style.display = 'none';
                document.getElementById('login-modal').style.display = 'flex';
            });
            
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // 测试账号验证
                if (email === 'admin@whu.edu.cn' && password === 'admin123') {
                    showMessage('管理员登录成功！', 'success');
                    // 模拟管理员登录
                    currentUser = { email: 'admin@whu.edu.cn' };
                    currentUserRole = 'admin';
                    updateAuthButton('admin@whu.edu.cn', 'admin', '系统管理员');
                    document.getElementById('login-modal').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    loadAdminData();
                    return;
                }
                
                const { data, error } = await signIn(email, password);
                
                if (error) {
                    showMessage('登录失败: ' + error.message, 'error');
                } else {
                    showMessage('登录成功！', 'success');
                    document.getElementById('login-modal').style.display = 'none';
                    
                    // 更新用户状态
                    currentUser = data.user;
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('role, full_name')
                        .eq('id', data.user.id)
                        .single();
                        
                    if (!userError && userData) {
                        currentUserRole = userData.role || 'student';
                        updateAuthButton(data.user.email, currentUserRole, userData.full_name);
                        
                        if (currentUserRole === 'admin') {
                            document.getElementById('admin-panel').style.display = 'block';
                            loadAdminData();
                        }
                    }
                }
            });
            
            // 注册表单提交
            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const fullName = document.getElementById('full-name').value;
                const studentId = document.getElementById('student-id').value;
                
                // 验证密码
                if (password.length < 6) {
                    showMessage('密码长度至少6位', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showMessage('两次输入的密码不一致', 'error');
                    return;
                }
                
                const { data, error } = await signUp(email, password, {
                    full_name: fullName,
                    student_id: studentId
                });
                
                if (error) {
                    showMessage('注册失败: ' + error.message, 'error');
                } else {
                    document.getElementById('register-form').reset();
                    document.getElementById('register-modal').style.display = 'none';
                }
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
